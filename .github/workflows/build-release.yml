name: Build and Release (ARM64 + Intel + Windows)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write
  actions: read

env:
  APP_NAME_CN: è¡¨æ ¼å·¥å…·
  APP_NAME_EN: excel_tool
  PYTHON_VERSION: '3.11'

jobs:
  build-arm64:
    runs-on: macos-15
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      arm64_size: ${{ steps.get_size.outputs.arm64_size }}
      macos_filename: ${{ steps.package.outputs.asset_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Get Version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-arm64-pyqt5-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          python -c "from PyQt5 import QtCore; print(f'PyQt5: {QtCore.PYQT_VERSION_STR}')"

      - name: Build ARM64
        run: |
          sed -i '' "s/target_arch=None/target_arch='arm64'/" main.spec
          sed -i '' "s|entitlements_file=None|entitlements_file='entitlements.plist'|" main.spec
          
          pyinstaller --noconfirm main.spec
          file "dist/${{ env.APP_NAME_CN }}.app/Contents/MacOS/main"

      - name: Package ARM64 (DMG)
        id: package
        run: |
          cd dist
          
          brew install create-dmg
          
          DMG_NAME="${{ env.APP_NAME_EN }}_AppleSilicon.dmg"
          VOL_NAME="${{ env.APP_NAME_CN }} Apple Silicon"
          
          if create-dmg \
            --volname "$VOL_NAME" \
            --window-pos 200 120 \
            --window-size 800 500 \
            --icon-size 100 \
            --app-drop-link 550 200 \
            --hide-extension "${{ env.APP_NAME_CN }}.app" \
            --format UDZO \
            "$DMG_NAME" \
            "${{ env.APP_NAME_CN }}.app" 2>/dev/null; then
          
            echo "dmg_created=true" >> $GITHUB_ENV
            mv "$DMG_NAME" "../$DMG_NAME"
            cd ..
            FILE_SIZE=$(du -h "$DMG_NAME" | cut -f1)
            echo "arm64_size=$FILE_SIZE" >> $GITHUB_OUTPUT
            echo "asset_path=$DMG_NAME" >> $GITHUB_OUTPUT
            echo "asset_name=$DMG_NAME" >> $GITHUB_OUTPUT
          
          else
            echo "dmg_created=false" >> $GITHUB_ENV
            ZIP_NAME="${{ env.APP_NAME_EN }}_AppleSilicon.zip"
            ditto -c -k --keepParent "${{ env.APP_NAME_CN }}.app" "../$ZIP_NAME"
            cd ..
            FILE_SIZE=$(du -h "$ZIP_NAME" | cut -f1)
            echo "arm64_size=$FILE_SIZE" >> $GITHUB_OUTPUT
            echo "asset_path=$ZIP_NAME" >> $GITHUB_OUTPUT
            echo "asset_name=$ZIP_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Get Size for Output
        id: get_size
        run: |
          if [ -f "${{ steps.package.outputs.asset_path }}" ]; then
            FILE_SIZE=$(du -h "${{ steps.package.outputs.asset_path }}" | cut -f1)
            echo "arm64_size=$FILE_SIZE" >> $GITHUB_OUTPUT
          else
            echo "arm64_size=æœªçŸ¥" >> $GITHUB_OUTPUT
          fi

      - name: Upload ARM64 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-build
          path: |
            ${{ steps.package.outputs.asset_path }}
          retention-days: 7

      - name: Print local Intel build instructions
        run: |
          echo "::notice title=Intel Macæœ¬åœ°æ„å»º::è¿è¡Œ: make build-intel æˆ– ./build-intel-local.sh ${{ steps.get_version.outputs.version }}"

  build-windows:
    runs-on: windows-latest
    needs: build-arm64
    outputs:  # ä¿®æ”¹ outputs
      windows_size: ${{ steps.package_windows.outputs.windows_size }}
      windows_filename: ${{ steps.package_windows.outputs.windows_filename }}
    strategy:
      matrix:
        architecture: [x64]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ matrix.architecture }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare Windows Resources
        run: |
          mkdir -p build/windows
          
          if (Test-Path "res/excel_tool.ico") {
            echo "æ‰¾åˆ°Windowså›¾æ ‡: res/excel_tool.ico"
            Copy-Item "res/excel_tool.ico" "build/windows/app_icon.ico"
            echo "å›¾æ ‡å·²å¤åˆ¶åˆ° build/windows/app_icon.ico"
          } else {
            echo "æœªæ‰¾åˆ° res/excel_tool.icoï¼Œæ­£åœ¨æœç´¢å…¶ä»–å›¾æ ‡æ–‡ä»¶..."
            Get-ChildItem "res/*.ico" -ErrorAction SilentlyContinue | ForEach-Object {
              echo "æ‰¾åˆ°ICOæ–‡ä»¶: $_"
              Copy-Item $_ "build/windows/app_icon.ico"
              echo "å·²å¤åˆ¶ $($_.Name) ä½œä¸ºåº”ç”¨å›¾æ ‡"
            }
          
            if (-Not (Test-Path "build/windows/app_icon.ico")) {
              echo "æœªæ‰¾åˆ°ICOå›¾æ ‡æ–‡ä»¶ï¼ŒWindowsåº”ç”¨å°†ä½¿ç”¨é»˜è®¤å›¾æ ‡"
              echo "å»ºè®®åœ¨ res/ ç›®å½•ä¸‹åˆ›å»º excel_tool.ico æ–‡ä»¶" > build/windows/icon_warning.txt
            }
          }

      - name: Build Windows Executable
        run: |
          echo "å¼€å§‹æ„å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶..."
          
          if (Test-Path "windows.spec") {
            echo "ä½¿ç”¨ç°æœ‰çš„windows.specæ–‡ä»¶"
          } else {
            Write-Error "windows.specæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          }
          
          pyinstaller --noconfirm windows.spec
          
          if (Test-Path "dist\${{ env.APP_NAME_EN }}.exe") {
            echo "Windowsæ„å»ºæˆåŠŸ"
            $file = Get-Item "dist\${{ env.APP_NAME_EN }}.exe"
            $fileSize = [math]::Round($file.Length / 1MB, 2)
            echo "å¯æ‰§è¡Œæ–‡ä»¶å¤§å°: $fileSize MB"
            echo "exe_size=$fileSize" >> $env:GITHUB_ENV
          } else {
            Write-Error "Windowsæ„å»ºå¤±è´¥ - æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
            Get-ChildItem "dist" -ErrorAction SilentlyContinue
            exit 1
          }

      - name: Add Windows Configuration Files
        run: |
          if (Test-Path "dist\${{ env.APP_NAME_EN }}.exe") {
            if (-Not (Test-Path "dist\config")) {
              New-Item -ItemType Directory -Path "dist\config" -Force
              echo "åˆ›å»ºconfigç›®å½•"
            }

            if (Test-Path "build/windows/app_icon.ico") {
              Copy-Item "build/windows/app_icon.ico" "dist\app_icon.ico"
              echo "å¤åˆ¶å›¾æ ‡åˆ°distç›®å½•"
            }

            # åˆ›å»ºç©ºç™½é…ç½®æ–‡ä»¶ï¼ˆæ— åç¼€åï¼‰
            echo "åˆ›å»ºç©ºç™½é…ç½®æ–‡ä»¶..."

            # åˆ›å»º service ç©ºç™½æ–‡ä»¶
            $servicePath = "dist\config\service"
            if (-Not (Test-Path $servicePath)) {
              "" | Out-File $servicePath -Encoding UTF8
              echo "åˆ›å»ºç©ºç™½æ–‡ä»¶: service"
            } else {
              echo "æ–‡ä»¶å·²å­˜åœ¨: service"
            }

            # åˆ›å»º from_account ç©ºç™½æ–‡ä»¶
            $fromAccountPath = "dist\config\from_account"
            if (-Not (Test-Path $fromAccountPath)) {
              "" | Out-File $fromAccountPath -Encoding UTF8
              echo "åˆ›å»ºç©ºç™½æ–‡ä»¶: from_account"
            } else {
              echo "æ–‡ä»¶å·²å­˜åœ¨: from_account"
            }

            # åˆ›å»º master_account ç©ºç™½æ–‡ä»¶
            $masterAccountPath = "dist\config\master_account"
            if (-Not (Test-Path $masterAccountPath)) {
              "" | Out-File $masterAccountPath -Encoding UTF8
              echo "åˆ›å»ºç©ºç™½æ–‡ä»¶: master_account"
            } else {
              echo "æ–‡ä»¶å·²å­˜åœ¨: master_account"
            }

            echo "ç©ºç™½é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"

            # æ˜¾ç¤ºåˆ›å»ºçš„æ–‡ä»¶åˆ—è¡¨
            echo "åˆ›å»ºçš„é…ç½®æ–‡ä»¶:"
            Get-ChildItem "dist\config" | ForEach-Object {
              echo "  - $($_.Name) ($($_.Length) bytes)"
            }
          }

      - name: Package Windows
        id: package_windows
        run: |
          cd dist
          
          Remove-Item -Path "*.spec" -ErrorAction SilentlyContinue
          Remove-Item -Path "build" -Recurse -ErrorAction SilentlyContinue -Force
          
          $ZIP_NAME = "${{ env.APP_NAME_EN }}_Windows_x64.zip"
          
          echo "è¦æ‰“åŒ…çš„æ–‡ä»¶:"
          Get-ChildItem -Recurse | Select-Object Name, Length | Format-Table
          
          echo "æ­£åœ¨åˆ›å»ºZIPåŒ…: $ZIP_NAME"
          Compress-Archive -Path * -DestinationPath "..\$ZIP_NAME" -Force
          
          $zipFile = Get-Item "..\$ZIP_NAME"
          $fileSize = [math]::Round($zipFile.Length / 1MB, 2)
          
          # ç›´æ¥è¾“å‡ºæ‰€æœ‰éœ€è¦çš„å€¼
          echo "asset_path=$ZIP_NAME" >> $env:GITHUB_OUTPUT
          echo "asset_name=$ZIP_NAME" >> $env:GITHUB_OUTPUT
          echo "windows_filename=$ZIP_NAME" >> $env:GITHUB_OUTPUT
          echo "windows_size=$fileSize MB" >> $env:GITHUB_OUTPUT
          
          echo "WindowsåŒ…å¤§å°: $fileSize MB"
          echo "ZIPæ–‡ä»¶è¯¦æƒ…:"
          Get-Item "..\$ZIP_NAME" | Format-List Name, Length, LastWriteTime

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            ${{ steps.package_windows.outputs.asset_path }}
          retention-days: 7

  create-release:
    runs-on: ubuntu-latest
    needs: [build-arm64, build-windows]
    if: success()

    steps:
      - name: Download macOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-build
          path: ./artifacts/macos

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./artifacts/windows

      - name: Prepare Release Files
        run: |
          echo "å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
          find ./artifacts -type f | sort
          
          if [ ! -f "./artifacts/macos/"* ] && [ ! -f "./artifacts/windows/"* ]; then
            echo "é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°å¯å‘å¸ƒçš„æ–‡ä»¶"
            exit 1
          fi

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build-arm64.outputs.version }}
          name: ${{ env.APP_NAME_CN }} ${{ needs.build-arm64.outputs.version }}
          body: |
            ## ğŸš€ ${{ env.APP_NAME_CN }} ${{ needs.build-arm64.outputs.version }}
            
            ### ğŸ“¦ æ„å»ºçŠ¶æ€
            | å¹³å° | æ¶æ„ | çŠ¶æ€ | æ–‡ä»¶å¤§å° |
            |------|------|------|----------|
            | **macOS** | Apple Silicon (ARM64) | âœ… å·²å®Œæˆ | ${{ needs.build-arm64.outputs.arm64_size || 'æœªçŸ¥' }} |
            | **Windows** | x64 (64ä½) | âœ… å·²å®Œæˆ | ${{ needs.build-windows.outputs.windows_size || 'æœªçŸ¥' }} |
            | **macOS** | Intel (x86_64) | â³ ç­‰å¾…æœ¬åœ°æ„å»º | - |
            
            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - **macOS**: 11.0 (Big Sur) æˆ–æ›´é«˜ç‰ˆæœ¬
            - **Windows**: Windows 10/11 64ä½ï¼Œè‡³å°‘4GBå†…å­˜
            - **é€šç”¨**: è‡³å°‘500MBå¯ç”¨ç£ç›˜ç©ºé—´
            
            ### ğŸ”§ ä¾èµ–ç‰ˆæœ¬
            - PyQt5: 5.15.11
            - pandas: 2.0.3
            - numpy: 1.24.3
            - xlsxwriter: 3.1.2
            - openpyxl: 3.1.2
            
            ### ğŸ“¥ å®‰è£…è¯´æ˜
            
            #### ğŸ macOS (Apple Silicon - M1/M2/M3/M4)
            1. ä¸‹è½½ **${{ needs.build-arm64.outputs.macos_filename }}**
            2. åŒå‡»æ‰“å¼€æ–‡ä»¶
            3. å°† **${{ env.APP_NAME_CN }}.app** æ‹–åˆ° **åº”ç”¨ç¨‹åº** æ–‡ä»¶å¤¹
            4. é¦–æ¬¡è¿è¡Œæ—¶ï¼Œå¦‚æœæç¤º"æ— æ³•æ‰“å¼€"ï¼Œè¯·åˆ°ï¼š
               **ç³»ç»Ÿè®¾ç½®** â†’ **éšç§ä¸å®‰å…¨** â†’ ç‚¹å‡»"ä»è¦æ‰“å¼€"
            
            #### ğŸ macOS (Intel)
            **æ³¨æ„**: Intelç‰ˆæœ¬éœ€è¦æœ¬åœ°æ„å»ºï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š
            ```bash
            # åœ¨Intel Macä¸Šè¿è¡Œ
            make build-intel
            # æˆ–
            ./build-intel-local.sh ${{ needs.build-arm64.outputs.version }}
            ```
            
            #### ğŸªŸ Windows 10/11 (64ä½)
            1. ä¸‹è½½ **${{ needs.build-windows.outputs.windows_filename }}**
            2. è§£å‹åˆ°ä»»æ„æ–‡ä»¶å¤¹ï¼ˆå»ºè®®ä¸è¦åœ¨Cç›˜æ ¹ç›®å½•ï¼‰
            3. è¿è¡Œ **${{ env.APP_NAME_EN }}.exe**
            4. å¦‚æœWindows Defenderæç¤ºï¼š
               - ç‚¹å‡»"æ›´å¤šä¿¡æ¯"
               - ç‚¹å‡»"ä»è¦è¿è¡Œ"
            
            ### âš ï¸ æ³¨æ„äº‹é¡¹
            - é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼ˆåŠ è½½ä¾èµ–åº“ï¼‰
            - ç¡®ä¿å¯¹å®‰è£…ç›®å½•æœ‰è¯»å†™æƒé™
            - å»ºè®®å…³é—­æ€æ¯’è½¯ä»¶å®æ—¶ç›‘æ§ï¼ˆå¦‚æœè¯¯æŠ¥ï¼‰
            - é…ç½®æ–‡ä»¶ä¿å­˜åœ¨ `config/` ç›®å½•ä¸­ï¼ˆåŒ…å« service, from_account, master_account ä¸‰ä¸ªé…ç½®æ–‡ä»¶ï¼‰
            
            ### ğŸ”— ä¸‹è½½é“¾æ¥
            **macOS Apple Silicon**: [${{ needs.build-arm64.outputs.macos_filename }}](https://github.com/${{ github.repository }}/releases/download/${{ needs.build-arm64.outputs.version }}/${{ needs.build-arm64.outputs.macos_filename }})
            
            **Intel Mac**: â³ è¯·ç­‰å¾… Intel ç‰ˆæœ¬ä¸Šä¼ ...
            
            **Windows 64ä½**: [${{ needs.build-windows.outputs.windows_filename }}](https://github.com/${{ github.repository }}/releases/download/${{ needs.build-arm64.outputs.version }}/${{ needs.build-windows.outputs.windows_filename }})
            
            ### ğŸ› ï¸ Intel Macæœ¬åœ°æ„å»ºæŒ‡å—
            ï¼ˆæ­¤éƒ¨åˆ†å†…å®¹åœ¨æœ¬åœ°æ„å»ºåä¼šè¢«æ›¿æ¢ï¼‰
            
            ### ğŸ› å·²çŸ¥é—®é¢˜
            - éƒ¨åˆ†æ€æ¯’è½¯ä»¶å¯èƒ½è¯¯æŠ¥ï¼Œè¯·æ·»åŠ åˆ°ä¿¡ä»»åˆ—è¡¨
            - Windowsç‰ˆæœ¬é¦–æ¬¡å¯åŠ¨è¾ƒæ…¢
            - macOSå¯èƒ½éœ€è¦æ‰‹åŠ¨æˆæƒ
            - Intel Macéœ€è¦æœ¬åœ°æ„å»º
            
            ### ğŸ“ æŠ€æœ¯æ”¯æŒ
            é‡åˆ°é—®é¢˜ï¼Ÿè¯· [æäº¤Issue](https://github.com/${{ github.repository }}/issues)
            
            ### ğŸ“… æ›´æ–°æ—¥å¿—
            **${{ needs.build-arm64.outputs.version }}**
            - æ–°å¢ Windows å¹³å°æ”¯æŒ
            - Windowsç‰ˆæœ¬åŒ…å«é»˜è®¤é…ç½®æ–‡ä»¶ï¼ˆservice, from_account, master_accountï¼‰
          draft: true
          prerelease: false
          files: |
            artifacts/macos/*
            artifacts/windows/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Release
        run: |
          echo "å‘å¸ƒåˆ›å»ºå®Œæˆ"
          echo "ç‰ˆæœ¬å·: ${{ needs.build-arm64.outputs.version }}"
          echo "macOS æ–‡ä»¶å¤§å°: ${{ needs.build-arm64.outputs.arm64_size }}"
          echo "Windows æ–‡ä»¶å¤§å°: ${{ needs.build-windows.outputs.windows_size }}"
          echo "å‘å¸ƒæ—¥æœŸ: $(date)"